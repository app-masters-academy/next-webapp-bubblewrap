# Bubblewrap

Bubblewrap is a set of tools and libraries designed to help developers to create, build and update projects for Android Applications that launch [Progressive Web App (PWA)](https://web.dev/progressive-web-apps/) using [Trusted Web Activity (TWA)](https://developer.chrome.com/docs/android/trusted-web-activity/overview/).

## Getting Started

**⚠ Attention! the application must be hosted or tunneled to work AND the application MUST have passed in all PWA insight checks ⚠**

**Before running any commands be sure to change the package.json file and replace all urls!**

### Bubblewrap scripts

- `bubblewrap init`: Initialize an android application from a specified web manifest.
  - `--manifest=${URL}/manifest.json`\*: Use this option to set the web manifest of the application that will be generated.
  - `--directory=${OUTPUT_PATH}`: Specify an output folder for the generated android application.
- `bubblewrap build`: Build the project into a apk.
- `bubblewrap install`: Install the application generated on any device connected to the debug.
- `bubblewrap validate`: Validate the application using the Google pageSpeed insight.
  - `--url=${URL}`\*: Set the web application url to be validated.

### Starting the application on localhost

The steps above are the initial configuration you must do to be able to start/generate the apk.

1. Build and start the web application.
2. Tunnel the application at port 3000.
3. Change the scripts `bubblewrap:validate` and `bubblewrap:init` on package.json and add the `https` url generated by the tunnel.

**⚠ The urls will be only used when generating the project for the first time or when updating**

#### First time: Generate the android project

1. Be sure to follow the firsts steps to start the web application.
2. Run `yarn bubblewrap:init` it will create a folder `/android` and start to initialize the android project. (A fill confirm inputs will be prompted)
3. After initialization run the command `yarn bubblewrap:build` to build the apk (You will be asked to input the keystore password you've create on the previous step).
4. Now with the application generate you must get the SHA256 fingerprint from the keystore file generated, you can do this by going to the `/android` folder and running the command `keytool -list -v -keystore ./KEYSTORE_NAME.keystore -alias KEYSTORE_ALIAS -storepass PASSWORD -keypass PASSWORD` after running this you should be able to see the `SHA256: XX:XX...` then save it, we are gonna use on the next step.
5. After grabbing the fingerprint you have to configure the TWA assetlinks for this first you have to create a file called `assetlinks.json` under `public/.well-known/` folder on the next application root. (It's content must be)

   ```json
   [
     {
       "relation": ["delegate_permission/common.handle_all_urls"],
       "target": {
         "namespace": "android_app",
         "package_name": "APPLICATION_PACKAGE",
         "sha256_cert_fingerprints": ["KEYSTORE_SHA256_FINGER_PRINT"]
       }
     }
   ]
   ```

6. After creating the file `public/.well-known/assetlinks.json` on the web application, you have to restart it.
7. If you want to run on a device be sure to connect it via adb, use `adb devices` to list all connected devices and `adb connect DEVICE_IP:5555` to connect via wifi.
8. On the web application root run `yarn bubblewrap:install` to install the generated application on the connected device.

#### Android project is already generated

1. Be sure to follow the firsts steps to start the web application.
2. If needed update the application by running `yarn bubblewrap:update`.
3. Put the generated keystore for the first build on the `./android` folder and run the command `yarn bubblewrap:build` to build the apk. (You will be asked keystore passwords)
4. If you want to run on a device be sure to connect it via adb, use `adb devices` to list all connected devices and `adb connect DEVICE_IP:5555` to connect via wifi.
5. On the web application root run `yarn bubblewrap:install` to install the generated application on the connected device.

## Known Problems

- The mobile application is displaying the browser custom bar when opened.
  - This problem is related with the `assetlinks.json` file when configured wrong.

## Keep learning

- [Trusted Web Activities](https://developer.chrome.com/docs/android/trusted-web-activity/overview)
- [Bubblewrap - github](https://github.com/GoogleChromeLabs/bubblewrap)
